#!/bin/bash

# Tailscale is optional — if TS_AUTHKEY is not set, exit cleanly
# so s6 does not keep restarting the daemon unnecessarily.
if [ -z "$TS_AUTHKEY" ]; then
    exec s6-svc -Od .
fi

mkdir -p /home/claude/.tailscale
chown claude:claude /home/claude/.tailscale
mkdir -p /var/run/tailscale

# Auto-detect TUN device availability for transparent networking
if [ -c /dev/net/tun ] && cat < /dev/net/tun > /dev/null 2>&1; then
    # Kernel TUN mode — transparent routing, no proxy needed
    echo "tailscaled: using kernel TUN mode (transparent networking)" >&2
    exec tailscaled \
        --statedir=/home/claude/.tailscale \
        --socket=/var/run/tailscale/tailscaled.sock
else
    # Userspace networking fallback — apps need SOCKS5 proxy
    echo "tailscaled: /dev/net/tun not available, falling back to userspace networking" >&2

    # Export proxy env vars so interactive shells can reach Tailscale peers
    cat > /etc/profile.d/tailscale-proxy.sh <<'EOF'
# Tailscale userspace-networking SOCKS5 proxy (auto-generated)
export ALL_PROXY=socks5h://localhost:1055
export HTTP_PROXY=socks5h://localhost:1055
export HTTPS_PROXY=socks5h://localhost:1055
export http_proxy=socks5h://localhost:1055
export https_proxy=socks5h://localhost:1055
EOF

    exec tailscaled \
        --tun=userspace-networking \
        --statedir=/home/claude/.tailscale \
        --socket=/var/run/tailscale/tailscaled.sock
fi
